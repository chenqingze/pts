<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <title>Title</title>
    <link href="/tracing-map.css" rel="stylesheet">
    <title>溯源信息</title>
</head>
<body>
<div id="container"></div>

<script type="text/javascript">
    // window._AMapSecurityConfig = {
    //     serviceHost:'您的代理服务器域名或地址/_AMapService',
    //     // 例如 ：serviceHost:'http://1.1.1.1:80/_AMapService',
    // }
    window._AMapSecurityConfig = {
        securityJsCode: 'b5153d0e85cf945408095a6b9e4f4379',
    }
</script>
<script src="https://webapi.amap.com/loader.js"></script>
<script type="text/javascript">
    AMapLoader.load({
        "key": "a5d7cb14f231eeaf3f0f99bd6963df7b",              // 申请好的Web端开发者Key，首次调用 load 时必填
        "version": "2.0",   // 指定要加载的 JSAPI 的版本，缺省时默认为 1.4.15
        "plugins": ['AMap.Driving'],           // 需要使用的的插件列表，如比例尺'AMap.Scale'等
        "AMapUI": {             // 是否加载 AMapUI，缺省不加载
            "version": '1.1',   // AMapUI 版本
            "plugins": ['overlay/SimpleMarker','ui/misc/PathSimplifier', 'lib/$'],       // 需要加载的 AMapUI ui插件
        },
        "Loca": {                // 是否加载 Loca， 缺省不加载
            "version": '2.0'  // Loca 版本
        },
    }).then((AMap) => {
        let map = new AMap.Map("container", {
            features:['bg','point'],
            isHotspot:false,
            center: [116.397559, 39.89621],
            zoom: 14
        });

        let drivingOption = {
            policy: AMap.DrivingPolicy.LEAST_TIME, // 其它policy参数请参考 https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingPolicy
            ferry: 1, // 是否可以使用轮渡
            province: '京', // 车牌省份的汉字缩写
        }

        // 构造路线导航类
        let driving = new AMap.Driving(drivingOption)

        // 根据起终点经纬度规划驾车导航路线
        driving.search(new AMap.LngLat(116.379028, 39.865042), new AMap.LngLat(113.43217,22.427883), function (status, result) {
            // result即是对应的驾车导航信息，相关数据结构文档请参考 https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingResult
            if (status === 'complete') {
                if (result.routes && result.routes.length) {
                    // 绘制第一条路线，也可以按需求绘制其它几条路线
                    drawRoute(result.routes[0])
                    console.log('绘制驾车路线完成', result);
                }
            } else {
                console.error('获取驾车数据失败：' + result);
            }
        });

        function drawRoute(route) {
            let path = parseRouteToPath(route)

            let startMarker = new AMap.Marker({
                position: path[0],
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
                map: map
            })

            let endMarker = new AMap.Marker({
                position: path[path.length - 1],
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
                map: map
            })

            let routeLine = new AMap.Polyline({
                path: path,
                isOutline: true,
                outlineColor: '#ffeeee',
                borderWeight: 2,
                strokeWeight: 5,
                strokeOpacity: 0.9,
                strokeColor: '#0091ff',
                lineJoin: 'round'
            })

            map.add(routeLine);

            // 调整视野达到最佳显示区域
            map.setFitView([startMarker, endMarker, routeLine])
        }

        // 解析DrivingRoute对象，构造成AMap.Polyline的path参数需要的格式
        // DrivingResult对象结构参考文档 https://lbs.amap.com/api/javascript-api/reference/route-search#m_DriveRoute
        function parseRouteToPath(route) {
            let path = []

            for (let i = 0, l = route.steps.length; i < l; i++) {
                let step = route.steps[i]

                for (let j = 0, n = step.path.length; j < n; j++) {
                    path.push(step.path[j])
                }
            }

            return path
        }
    }).catch((e) => {
        console.error(e);  //加载错误提示
    });
</script>
</body>
</html>
